<link rel="stylesheet" href="/css/inbox.css">

<script>

    //codigo para el menu sidebar deslizante
    var opened = false;
    var port = 80; //quizas cambiar y usar handlebars?
    function openSidebar() {
        if(opened) {
            closeSidebar();
        } else {
            document.getElementById("mysidebar").style.width = "15%";
            document.getElementById("main").style.marginLeft = "15%";
            opened = true;
        }
    }

    function closeSidebar() {
        document.getElementById("mysidebar").style.width = "0%";
        document.getElementById("main").style.marginLeft = "0%";
        opened = false;
    }

    var sock;
    var chats;
    var rel_chat = {};

    function set_chats(c, r_c) {
        chats = c;
        rel_chat = r_c;
    }

    var username = '{{username}}'; //handlebars
    var destinatario_actual;
    sock = new WebSocket(`ws://localhost:${port}`);
    
    sock.onopen = function(e) {
        sock.send(JSON.stringify({
            type: 'registration',
            username: username
        }))
    };

    sock.onmessage = function(msg) {
        var f = true //provisional, luego sera solo json
        try {
            var json = JSON.parse(msg.data)
        } catch(e) {
            console.log(`received: ${msg.data}`)
            f = false
        }
        if(f) {
            if(json.type == 'inbox') {
                console.log(json)

                set_chats(json.chats, json.users)
                for(var interaccion in json.users) {
                    if(json.users[interaccion] == username) {
                        continue //if its our own, ignore
                    }
                    document.getElementById('inbox-side-list').innerHTML += `
                        <a href="#" onclick="cargar_chat('${interaccion}')">
                            <div class="inbox-card">
                                <img src="/img/placeholder.png">
                                <div class="summary">
                                    <p class="inbox-username">${json.users[interaccion]}</p>
                                    <p>mensaje</p> <!--usar solo un max de caracteres para esto-->
                                </div>
                            </div>
                        </a>
                    `
                }
            }
        }
        
        
    }

    function enviarMensaje() {
        var mensaje = document.getElementById('mensaje').value;
        var json = {
            type: 'message',
            mensaje: mensaje,
            remitente: username,
            destinatario_actual: destinatario_actual
        };
        console.log(`enviando mensaje: ${JSON.stringify(json)}`)
        sock.send(JSON.stringify(json));
    }

    function render_chat(chat) {
        //get user id
        var result = '';
        var usr_id;
        for(var key in rel_chat) {
            if(rel_chat[key] == username) {
                usr_id = key;
                break;
            }
        }
        chat.forEach((message) => {
            if(message.id_destinatario == usr_id) {
                result += `
                <div class="message-bubble-left">
                    <p>
                        ${message.contenido}
                    </p>
                </div>
                `
            } else if(message.id_remitente == usr_id) {
                result += `
                    <div class="message-bubble-right">
                        <p>
                            ${message.contenido}
                        </p>
                    </div>
                `
            }
        })
        return result
    }

    function cargar_chat(user) {
        cambiar_destinatario(user)
        var f = false;
        for(var id in rel_chat) {
            if(id == user) {
                f = true;
            }
        }
        if(f) {
            document.getElementById('chat').innerHTML = render_chat(chats[user])
        }
        
    }

    function cambiar_destinatario(user) {
        /*destinatario_actual = user;*/
        console.log(rel_chat)
        console.log(user)
        destinatario_actual = rel_chat[user]
        console.log(`destinatario actual: ${destinatario_actual}`)
    }

    function cambiar_destinatario_illegal(user) {
        destinatario_actual = user;
        console.log(`destinatario actual ilegal: ${destinatario_actual}`)
    }


</script>


<div class="top-bar">
    <button class="open-sidebar" onclick="openSidebar()">Abrir</button>

    <img src="/img/placeholder.png">
</div>

<div class="contenido">
    <div class="sidebar" id="mysidebar">
        <!--<a href="javascript::void(0)" class="close-sidebar" onclick="closeSidebar()">X</a>-->
        <a href="/inbox"><div class="icono-sidebar">s</div>Inbox</a>
        <a href="/matches"><div class="icono-sidebar">s</div>Matches</a>
        <a href="/perfil"><div class="icono-sidebar">s</div>Perfil</a>
        <a href="/configuracion"><div class="icono-sidebar">s</div>Configuración</a>
        <a href="/logout"><div class="icono-sidebar">s</div>Cerrar sesión</a>
    </div>

    <div id="main">
        <div class="row">
            <div class="col-3 inbox-side-list" id="inbox-side-list">
                <!-- <a href="#" onclick="cargar_chat('nuevo')">
                    <div class="inbox-card">
                        <img src="/img/placeholder.png">
                        <div class="summary">
                            <p class="inbox-username">nuevo</p>
                            <p>mensaje</p>
                        </div>
                    </div>
                </a> -->
            <a href="#" onclick="cambiar_destinatario_illegal('diespeso')">
                    <div class="inbox-card">
                        <img src="/img/placeholder.png">
                        <div class="summary">
                            <p class="inbox-username">diespeso</p>
                            <p>mensaje</p>
                        </div>
                    </div>
                </a>
            </div>
            <div class="col-9 chat-container">
                <div class="row centered">
                    <div class="chat" id="chat">
                        <div class="message-bubble-left">
                            <p>
                                texto
                            </p>
                        </div>
                        <div class="message-bubble-right">
                            <p>
                                texto
                            </p>
                        </div>
                    </div>
                </div>

                <div class="row centered">
                    <div class="col-11  new-message-container">
                        <form>
                            <input type="textfield" id="mensaje">
                        </form>
                    </div>
                    <div class="col-1 btn-send">
                        <button onclick="enviarMensaje()">
                            Enviar
                        </button>
                    </div>
                </div>

            </div>
        </div>

        
    </div>
</div>

